# experiments/exp_adaptgate.yaml

# Snapshot-Ensemble + Adaptive-Gate 실험 구성
imports:
  - configs/base.yaml     # <-- 공통 기본값만 global import
  # 개별 Job 에서 필요한 method/scenario 를 따로 불러옵니다.

# ---- 교사 설정 ----
teacher1_type: resnet152
teacher1_ckpt: "${ASMB_KD_ROOT}/checkpoints/resnet152_ft.pth,\
  ${ASMB_KD_ROOT}/checkpoints/snapshots/snap_ep020.pth,\
  ${ASMB_KD_ROOT}/checkpoints/snapshots/snap_ep040.pth,\
  ${ASMB_KD_ROOT}/checkpoints/snapshots/snap_ep060.pth"

# (efficientnet-B2 단일 교사 CKPT 예시)
teacher2_ckpt: "${ASMB_KD_ROOT}/checkpoints/efficientnet_b2_ft.pth"

# 공통 체크포인트 폴더도 동일 변수 사용
checkpoint_dir: "${ASMB_KD_ROOT}/checkpoints"

# (옵션) 백본명 명시 – 기본은 resnet152
snapshot_backbone: resnet152

# ---- 실험 식별자 ----
exp_id: adapt_gate_snap

# ============================================================
#   Adapt-Gate 2-Stage 파이프라인
#     1) ConvNeXt-Tiny  CE 파인튜닝
#     2) Gate-VIB-KD  (Teacher 캐시 + AccumSteps)
# ------------------------------------------------------------
#   사용법:  sbatch scripts/run_launcher.sh experiments/exp_adaptgate.yaml
# ============================================================

name: adapt_gate_speed

jobs:

# ------------------------------------------------------------
# ①  CE  파인튜닝  (12 epoch, 부분 freeze)
# ------------------------------------------------------------
  - id: ce_ft
    gpus: 1                # 1×A100 이면 35~45 분

    # ⚠ first‑wins → scenario 를 **먼저** 넣어 method: ce 보존
    # 첫 파일이 finetune_ce  (마지막 wins 규칙 → method: ce 유지)
# ① base → ② finetune_ce   (마지막 wins → method: ce 유지)
    cfg: configs/base.yaml,configs/scenario/finetune_ce.yaml

# ------------------------------------------------------------
# ②  Gate-VIB  KD   (Teacher 캐시 + 큰 배치 + Accum 2)
#     ※ ①이 끝나야 student_ce_ckpt 가 생성되므로 deps 지정
# ------------------------------------------------------------
  - id: kd_speed
    deps: [ce_ft]          # ← ce_ft 완료 후에만 실행
    gpus: 1

    # 캐시가 없다면 최초 1회 자동 생성
    pre_cmd: |
      if [ ! -f cache/rs152_effb2_cifar100.pt ]; then
        python utils/make_cache.py \
               --cfg configs/base.yaml \
               --out cache/rs152_effb2_cifar100.pt
      fi

    # KD 단계도 method 가 vib 로 남도록 kd_speed 를 **맨 앞**에
    # kd_speed → vib/standard → base  (마지막 wins → method: vib 유지)
# ① base → ② vib/standard 기본값 → ③ kd_speed(override, method:vib)
    cfg: configs/base.yaml,configs/method/vib/standard.yaml,configs/scenario/kd_speed.yaml
